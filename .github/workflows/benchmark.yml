name: Benchmark Regression Check

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BENCH_COUNT: "5"
  GO_VERSION: "1.22"

permissions:
  contents: read
  pull-requests: write

jobs:
  benchmark:
    name: Benchmark Comparison
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install benchstat
        run: go install golang.org/x/perf/cmd/benchstat@latest

      # On PRs: try to restore cached baseline results from the latest main push.
      # Each main push saves with a unique key (benchmark-baseline-<sha>).
      # restore-keys prefix matching finds the most recent one.
      - name: Restore cached baseline
        if: github.event_name == 'pull_request'
        id: cache-baseline
        uses: actions/cache/restore@v4
        with:
          path: bench-baseline.txt
          key: benchmark-baseline-${{ github.event.pull_request.base.sha }}
          restore-keys: benchmark-baseline-

      - name: Run benchmarks
        run: |
          go test -bench=. -benchmem -benchtime=100ms -count=${{ env.BENCH_COUNT }} \
            -run='^$' -timeout=10m ./... | tee bench-current.txt

      # On push to main: save results as the new baseline for future PRs.
      # Uses a per-SHA key so each push creates a new entry. The PR restore
      # step uses restore-keys prefix matching to find the most recent one.
      # The path must match the restore step (bench-baseline.txt).
      - name: Save baseline to cache
        if: github.event_name == 'push'
        run: cp bench-current.txt bench-baseline.txt

      - name: Upload baseline cache
        if: github.event_name == 'push'
        uses: actions/cache/save@v4
        with:
          path: bench-baseline.txt
          key: benchmark-baseline-${{ github.sha }}

      - name: Compare with benchstat
        if: github.event_name == 'pull_request'
        id: benchstat
        run: |
          if [ ! -s bench-baseline.txt ]; then
            echo "No cached baseline found â€” showing PR results only."
            echo "has_comparison=false" >> "$GITHUB_OUTPUT"
            {
              echo 'result<<BENCHSTAT_EOF'
              echo '## Benchmark Results (no baseline to compare)'
              echo ''
              echo 'No cached baseline from main found. Results will be cached'
              echo 'once this PR merges and the next push to main runs.'
              echo ''
              echo '```'
              cat bench-current.txt
              echo '```'
              echo 'BENCHSTAT_EOF'
            } >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "has_comparison=true" >> "$GITHUB_OUTPUT"

          benchstat base=bench-baseline.txt pr=bench-current.txt \
            > benchstat-output.txt 2>&1 || true

          {
            echo 'result<<BENCHSTAT_EOF'
            echo '## Benchmark Comparison (main baseline vs PR)'
            echo ''
            echo '<details>'
            echo '<summary>Click to expand benchstat output</summary>'
            echo ''
            echo '```'
            cat benchstat-output.txt
            echo '```'
            echo ''
            echo '</details>'
            echo ''
            echo '_Compared against cached baseline from the latest main push._'
            echo 'BENCHSTAT_EOF'
          } >> "$GITHUB_OUTPUT"

          if grep -E '^\S.*\+$' benchstat-output.txt | grep -qv '^name'; then
            echo "has_regression=true" >> "$GITHUB_OUTPUT"
            echo "::warning::Benchstat detected statistically significant regressions."
          else
            echo "has_regression=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Post PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          BENCH_RESULT: ${{ steps.benchstat.outputs.result }}
        with:
          script: |
            const body = process.env.BENCH_RESULT;
            const marker = '<!-- benchmark-comparison-comment -->';
            const fullBody = marker + '\n' + body;

            let existingComment = null;
            try {
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                per_page: 100,
              });
              existingComment = comments.find(c => c.body.includes(marker));
            } catch (e) {
              core.warning(`Could not list PR comments: ${e.message}`);
            }

            try {
              if (existingComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                  body: fullBody,
                });
                core.info(`Updated existing benchmark comment ${existingComment.id}`);
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: fullBody,
                });
                core.info('Created new benchmark comment');
              }
            } catch (e) {
              core.warning(`Could not post PR comment: ${e.message}. This is expected for PRs from forks.`);
            }

      - name: Annotate regressions
        if: steps.benchstat.outputs.has_regression == 'true'
        run: |
          echo "::warning::Benchmark regressions detected. Review the benchstat comparison above."
          # Informational only. To make this a hard gate, change to: exit 1
          exit 0
